# ملخص التحديثات الجديدة

## المميزات المضافة

### 1. إصلاح مشكلة إضافة المستأجرين ✅
**المشكلة:** كان هناك خطأ عند إضافة مستأجر جديد بسبب نقص أعمدة في جدول `tenants`

**الحل:**
- إضافة ملف `upgrade_schema.php` لترقية قاعدة البيانات
- إضافة الأعمدة التالية لجدول `tenants`:
  - `id_type`: نوع الهوية (هوية وطنية، إقامة، جواز سفر، سجل تجاري)
  - `address`: عنوان المستأجر
  - `id_photo`: صورة الهوية
- تحديث صفحة المستأجرين لاستخدام هذه الحقول بشكل صحيح

**كيفية التطبيق:**
1. قم بتشغيل `upgrade_schema.php` مرة واحدة فقط عبر المتصفح
2. بعد التشغيل، احذف الملف لأسباب أمنية
3. الآن يمكنك إضافة مستأجرين بدون أخطاء

---

### 2. إضافة خيار تبديل المظهر (فاتح/داكن) ✅
**الوصف:** إمكانية التبديل بين المظهر الفاتح والداكن حسب الرغبة

**المميزات:**
- زر في شريط الأدوات العلوي لتبديل المظهر
- أيقونة ديناميكية (شمس للمظهر الداكن، قمر للمظهر الفاتح)
- تحفظ الإعدادات في قاعدة البيانات
- ألوان محسّنة للمظهر الفاتح تناسب القراءة النهارية
- انتقال سلس بين المظاهر

**الملفات المعدلة:**
- `includes/header.php`: إضافة متغيرات CSS للمظهر الفاتح
- `includes/footer.php`: إضافة JavaScript لتبديل المظهر
- `routes/toggle_theme.php`: API endpoint لحفظ الإعدادات

---

### 3. عرض الوحدات كبطاقات أيقونية مع الفلترة ✅
**الوصف:** تم إعادة تصميم صفحة الوحدات بالكامل لعرضها كبطاقات بدلاً من جدول

**المميزات:**
- **بطاقات أيقونية جميلة:**
  - عرض شعار المحل إذا كان متوفراً
  - أيقونات تلقائية حسب نوع الوحدة (محل، شقة، فيلا، مكتب)
  - تصميم عصري مع تأثيرات حركية عند المرور

- **حالة الوحدة الواضحة:**
  - شارة ملونة تظهر "مؤجر" (أخضر) أو "خالي" (أزرق)
  - عرض اسم المستأجر الحالي للوحدات المؤجرة
  - تحديث تلقائي للحالة عند إنشاء/حذف عقود

- **فلترة قوية:**
  - فلترة حسب العقار
  - فلترة حسب الحالة (مؤجر/خالي)
  - فلترة فورية بدون إعادة تحميل الصفحة

- **معلومات شاملة:**
  - اسم المحل (إذا كان محلاً تجارياً)
  - اسم الوحدة
  - العقار التابع له
  - النوع والسعر السنوي
  - المستأجر الحالي (للمؤجرة)

**الملفات المعدلة:**
- `pages/units.php`: إعادة تصميم كامل للعرض والفلترة
- `includes/header.php`: إضافة CSS لتنسيق البطاقات

---

### 4. إضافة حقول المحل التجاري للوحدات ✅
**الوصف:** دعم كامل للمحلات التجارية مع اسم وشعار مخصص

**الحقول الجديدة:**
- `shop_name`: اسم المحل التجاري
- `shop_logo`: شعار المحل (صورة)
- `tenant_name`: اسم المستأجر الحالي (يتم تحديثه تلقائياً)

**المميزات:**
- إضافة شعار المحل عند إنشاء/تعديل الوحدة
- عرض الشعار بشكل بارز في البطاقة
- معاينة الشعار الحالي عند التعديل
- يظهر اسم المحل بدلاً من رقم الوحدة في البطاقة

---

### 5. مزامنة تلقائية بين العقود والوحدات ✅
**الوصف:** تحديث تلقائي لبيانات الوحدات عند إدارة العقود

**كيف يعمل:**
1. **عند إنشاء عقد جديد:**
   - تتحول حالة الوحدة إلى "مؤجر"
   - يُسجل اسم المستأجر في الوحدة
   - تظهر البيانات فوراً في صفحة الوحدات

2. **عند حذف عقد:**
   - تعود حالة الوحدة إلى "خالي"
   - يتم مسح اسم المستأجر
   - تحديث البطاقة تلقائياً

**الملفات المعدلة:**
- `pages/contracts.php`: إضافة كود المزامنة

---

## خطوات التطبيق

### خطوة 1: ترقية قاعدة البيانات
```bash
# افتح المتصفح وانتقل إلى:
http://yourdomain.com/upgrade_schema.php

# بعد التشغيل بنجاح، احذف الملف:
rm upgrade_schema.php
```

### خطوة 2: تجربة المميزات الجديدة

#### تجربة المظهر الفاتح/الداكن:
1. انقر على أيقونة الشمس/القمر في شريط الأدوات العلوي
2. لاحظ التغيير الفوري في الألوان
3. أعد تحميل الصفحة للتأكد من حفظ الإعداد

#### تجربة إضافة مستأجر:
1. اذهب إلى صفحة "المستأجرين"
2. انقر "إضافة مستأجر"
3. املأ جميع الحقول بما فيها نوع الهوية والعنوان
4. احفظ وتحقق من عدم ظهور أخطاء

#### تجربة الوحدات الجديدة:
1. اذهب إلى صفحة "الوحدات"
2. لاحظ العرض الجديد بالبطاقات
3. جرب الفلترة بالعقار والحالة
4. أضف وحدة جديدة مع اسم وشعار محل
5. انقر على بطاقة الوحدة لرؤية التفاصيل

#### تجربة المزامنة:
1. أنشئ عقد جديد لوحدة خالية
2. ارجع لصفحة الوحدات
3. لاحظ تغيير حالة الوحدة إلى "مؤجر" وظهور اسم المستأجر
4. احذف العقد
5. لاحظ عودة الوحدة إلى "خالي"

---

## الملفات الجديدة والمعدلة

### ملفات جديدة:
- `upgrade_schema.php`: ملف الترقية (يُحذف بعد الاستخدام)
- `routes/toggle_theme.php`: API لتبديل المظهر
- `UPGRADE_NOTES.md`: هذا الملف (توثيق)

### ملفات معدلة:
- `includes/header.php`: إضافة CSS للمظهر الفاتح + زر التبديل + CSS البطاقات
- `includes/footer.php`: إضافة JavaScript لتبديل المظهر
- `pages/tenants.php`: إضافة دعم للحقول الجديدة
- `pages/units.php`: إعادة تصميم كامل + فلترة + دعم الشعارات
- `pages/contracts.php`: إضافة مزامنة مع جدول الوحدات

---

## ملاحظات مهمة

1. **الأمان:** احذف ملف `upgrade_schema.php` بعد التشغيل
2. **النسخ الاحتياطي:** قم بعمل نسخة احتياطية من قاعدة البيانات قبل الترقية
3. **الصلاحيات:** تأكد أن مجلد `uploads` لديه صلاحيات الكتابة (755)
4. **التوافق:** جميع التغييرات متوافقة مع الإصدار الحالي
5. **الأداء:** لا تؤثر التغييرات على سرعة النظام

---

## الدعم

في حال واجهتك أي مشكلة:
1. تأكد من تشغيل `upgrade_schema.php` بنجاح
2. راجع سجلات الأخطاء في PHP
3. تأكد من صلاحيات قاعدة البيانات
4. تحقق من إصدار PHP (يجب أن يكون 7.4 أو أحدث)

---

**تم التطوير بعناية** ✨
